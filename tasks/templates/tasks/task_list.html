<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .task-list {
            list-style: none;
            padding: 0;
        }
        .task-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-title {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0;
        }
        .task-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: flex-end;
        }
        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 5px;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #cc0000;
        }
        .task-status-select {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
        }
        .task-status-select.pending {
            border-color: #ffd700;
            background-color: #fff8dc;
        }
        .task-status-select.in_progress {
            border-color: #87ceeb;
            background-color: #f0f8ff;
        }
        .task-status-select.completed {
            border-color: #90ee90;
            background-color: #f0fff0;
        }
        .task-date {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .task-description {
            color: #444;
            margin-top: 5px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            animation: fadeOut 3s forwards;
        }
        .status-message.success {
            background-color: #90ee90;
            color: #006400;
        }
        .status-message.error {
            background-color: #ffcccb;
            color: #8b0000;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
        .task-item {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .add-task-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 20px;
            transition: background-color 0.2s;
        }
        .add-task-btn:hover {
            background-color: #45a049;
        }
        .new-task-form {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.3s;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group textarea,
        .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .cancel-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .cancel-btn:hover {
            background-color: #da190b;
        }

        .editable-field {
            padding: 5px 0;
            margin: 5px 0;
            border-bottom: 2px solid #4CAF50;
            background-color: transparent;
        }

        .editable-field input,
        .editable-field textarea {
            width: 100%;
            padding: 5px 0;
            border: none;
            font-family: inherit;
            font-size: inherit;
            background: transparent;
            outline: none;
        }

        .editable-field input[type="datetime-local"] {
            padding: 5px;
        }

        .edit-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .save-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }

        .save-btn:hover {
            background-color: #45a049;
        }

        .task-item .cancel-btn {
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <h1>Task Manager</h1>
    <button class="add-task-btn" onclick="toggleNewTaskForm()">+ Add New Task</button>
    
    <div id="newTaskForm" class="new-task-form">
        <div class="form-group">
            <label for="taskTitle">Title:</label>
            <input type="text" id="taskTitle" required>
        </div>
        <div class="form-group">
            <label for="taskDescription">Description:</label>
            <textarea id="taskDescription"></textarea>
        </div>
        <div class="form-group">
            <label for="taskDueDate">Due Date:</label>
            <input type="datetime-local" id="taskDueDate">
        </div>
        <div class="form-buttons">
            <button class="cancel-btn" onclick="toggleNewTaskForm()">Cancel</button>
            <button class="submit-btn" onclick="createNewTask()">Create Task</button>
        </div>
    </div>

    <ul class="task-list">
        {% for task in tasks %}
        <li class="task-item" data-task-id="{{ task.id }}">
            <div class="task-header">
                <h2 class="task-title editable-field-title" ondblclick="makeEditable(this)" data-field="title" data-original="{{ task.title }}">{{ task.title }}</h2>
                <div class="task-actions">
                    <select class="task-status-select {{ task.status }}" data-task-id="{{ task.id }}" onchange="updateTaskStatus(this)">
                        <option value="pending" {% if task.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <button class="delete-btn" onclick="deleteTask({{ task.id }})">Delete</button>
                </div>
            </div>
            <p class="task-description editable-field-description" ondblclick="makeEditable(this)" data-field="description" data-original="{{ task.description|default:'' }}">
                {% if task.description %}{{ task.description }}{% endif %}
            </p>
            <div class="task-date">
                {% if task.due_date %}
                <div class="editable-field-due_date" ondblclick="makeEditable(this)" data-field="due_date" data-original="{{ task.due_date|date:'Y-m-d\TH:i' }}">Due: {{ task.due_date|date:"F j, Y, g:i a" }}</div>
                {% endif %}
                <div>Created: {{ task.created_at|date:"F j, Y, g:i a" }}</div>
                <div>Last Updated: {{ task.update_task|date:"F j, Y, g:i a" }}</div>
            </div>
            <div class="edit-actions" style="display: none;">
                <button class="save-btn" onclick="saveChanges(this)">Save Changes</button>
                <button class="cancel-btn" onclick="cancelEdit(this)">Cancel</button>
            </div>
        </li>
        {% empty %}
        <li class="task-item">
            <p>No tasks found.</p>
        </li>
        {% endfor %}
    </ul>
    <div id="statusMessage" class="status-message"></div>

    <script>
        function showMessage(message, isSuccess) {
            const messageElement = document.getElementById('statusMessage');
            messageElement.textContent = message;
            messageElement.className = 'status-message ' + (isSuccess ? 'success' : 'error');
            messageElement.style.display = 'block';
            
            // Reset the animation by removing and re-adding the element
            messageElement.style.animation = 'none';
            messageElement.offsetHeight; // Trigger reflow
            messageElement.style.animation = 'fadeOut 3s forwards';
            
            // Hide the message after animation
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            fetch(`/api/tasks/${taskId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1]
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete task');
                }
                // Remove the task element from the DOM
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`).closest('.task-item');
                taskElement.style.animation = 'fadeOut 0.5s forwards';
                setTimeout(() => {
                    taskElement.remove();
                    // Check if there are no tasks left
                    if (document.querySelectorAll('.task-item').length === 0) {
                        const taskList = document.querySelector('.task-list');
                        taskList.innerHTML = '<li class="task-item"><p>No tasks found.</p></li>';
                    }
                }, 500);
                showMessage('Task deleted successfully', true);
            })
            .catch(error => {
                showMessage('Failed to delete task: ' + error.message, false);
            });
        }

        function toggleNewTaskForm() {
            const form = document.getElementById('newTaskForm');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                
                // Reset form
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDescription').value = '';
                document.getElementById('taskDueDate').value = '';
                form.style.display = 'none';
            }
        }

        function createNewTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;

            if (!title) {
                showMessage('Title is required', false);
                return;
            }

            const data = {
                title: title,
                description: description,
                status: 'pending'
            };

            if (dueDate) {
                data.due_date = dueDate;
            }

            fetch('/api/tasks/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1]
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create task');
                }
                return response.json();
            })
            .then(task => {
                // Create new task element
                const taskList = document.querySelector('.task-list');
                if (taskList.querySelector('p')?.textContent === 'No tasks found.') {
                    taskList.innerHTML = '';
                }

                const taskElement = document.createElement('li');
                taskElement.className = 'task-item';
                taskElement.innerHTML = `
                    <div class="task-header">
                        <h2 class="task-title">${task.title}</h2>
                        <div class="task-actions">
                            <select class="task-status-select ${task.status}" data-task-id="${task.id}" onchange="updateTaskStatus(this)">
                                <option value="pending" ${task.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                            <button class="delete-btn" onclick="deleteTask(${task.id})">Delete</button>
                        </div>
                    </div>
                    ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                    <div class="task-date">
                        ${task.due_date ? `<div>Due: ${formatDate(task.due_date)}</div>` : ''}
                        <div>Created: ${formatDate(task.created_at)}</div>
                        <div>Last Updated: ${formatDate(task.update_task)}</div>
                    </div>
                `;
                taskList.insertBefore(taskElement, taskList.firstChild);

                // Hide and reset form
                toggleNewTaskForm();
                showMessage('Task created successfully', true);
            })
            .catch(error => {
                showMessage('Failed to create task: ' + error.message, false);
            });
        }

        function formatDate(dateString) 
        {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: 'numeric', minute: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }

        function makeEditable(element) {
            const fieldType = element.dataset.field;
            const originalValue = element.dataset.original;
            
            let inputElement;
            if (fieldType === 'description') {
                inputElement = document.createElement('textarea');
                inputElement.value = originalValue || '';
                inputElement.className = 'edit-input-description';
            } else if (fieldType === 'due_date') {
                inputElement = document.createElement('input');
                inputElement.type = 'datetime-local';
                inputElement.value = originalValue || '';
                inputElement.className = 'edit-input-due_date';
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = originalValue || '';
                inputElement.className = 'edit-input-' + fieldType;
            }

            // Create editable container
            const editableDiv = document.createElement('div');
            editableDiv.className = 'editable-field';
            editableDiv.dataset.field = fieldType;
            editableDiv.appendChild(inputElement);

            // Store the original content and value
            editableDiv.dataset.originalContent = element.innerHTML;
            editableDiv.dataset.originalValue = originalValue || '';

            // Replace the element content with the input
            element.innerHTML = '';
            element.appendChild(editableDiv);

            // Show the edit actions
            const editActions = element.closest('.task-item').querySelector('.edit-actions');
            editActions.style.display = 'flex';

            // Focus the input
            inputElement.focus();
        }

        function saveChanges(button) {
            const taskItem = button.closest('.task-item');
            const taskId = taskItem.dataset.taskId;
            const editableFields = taskItem.querySelectorAll('.editable-field');
            
            if (editableFields.length === 0) return;

            const updates = {};
            editableFields.forEach(field => {
                const fieldType = field.dataset.field;
                const input = field.querySelector('input, textarea');
                if (fieldType && input && input.value.trim() !== '') {
                    updates[fieldType] = input.value.trim();
                }
            });

            fetch(`/api/tasks/${taskId}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1]
                },
                body: JSON.stringify(updates)
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to update task');
                return response.json();
            })
            .then(data => {
                // Update the UI with new values
                editableFields.forEach(field => {
                    const parent = field.parentElement;
                    const fieldType = field.dataset.field;
                    const newValue = updates[fieldType];
                    
                    // Update the display and data attributes
                    parent.dataset.field = fieldType;
                    parent.dataset.original = newValue;
                    
                    if (fieldType === 'due_date') {
                        parent.innerHTML = 'Due: ' + formatDate(newValue);
                    } else {
                        parent.innerHTML = newValue || '';
                    }

                    // Restore the original classes
                    parent.className = parent.className.replace('editing', '');
                    if (fieldType === 'title') {
                        parent.className = 'task-title editable-field-title';
                    } else if (fieldType === 'description') {
                        parent.className = 'task-description editable-field-description';
                    } else if (fieldType === 'due_date') {
                        parent.className = 'editable-field-due_date';
                    }
                });

                // Hide edit actions
                taskItem.querySelector('.edit-actions').style.display = 'none';
                showMessage('Task updated successfully', true);
            })
            .catch(error => {
                showMessage('Failed to update task: ' + error.message, false);
                cancelEdit(button);
            });
        }

        function cancelEdit(button) {
            const taskItem = button.closest('.task-item');
            const editableFields = taskItem.querySelectorAll('.editable-field');

            editableFields.forEach(field => {
                const parent = field.parentElement;
                const fieldType = field.dataset.field;
                const originalContent = field.dataset.originalContent;
                const originalValue = field.dataset.originalValue;
                
                if (fieldType === 'due_date' && originalValue) {
                    parent.innerHTML = originalContent;
                } else {
                    parent.innerHTML = originalValue || '';
                }
                
                // Restore the original data attributes
                parent.dataset.field = fieldType;
                parent.dataset.original = originalValue;
                parent.className = parent.className.replace('editing', '');
            });

            // Hide edit actions
            taskItem.querySelector('.edit-actions').style.display = 'none';
        }
            
        function updateTaskStatus(selectElement) {
            const taskId = selectElement.dataset.taskId;
            const newStatus = selectElement.value;
            
            // Update the select element's class
            selectElement.className = 'task-status-select ' + newStatus;

            // Call the API to update the task status
            fetch(`/api/tasks/${taskId}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.cookie.split('; ').find(row => row.startsWith('csrftoken=')).split('=')[1]
                },
                body: JSON.stringify({
                    status: newStatus
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update status');
                }
                return response.json();
            })
            .then(data => {
                showMessage('Status updated successfully!', true);
            })
            .catch(error => {
                showMessage('Error updating status. Please try again.', false);
                // Revert the select to the previous value
                const options = selectElement.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].defaultSelected) {
                        selectElement.selectedIndex = i;
                        selectElement.className = 'task-status-select ' + options[i].value;
                        break;
                    }
                }
            });
        }
    </script>
</body>
</html>